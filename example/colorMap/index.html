<!DOCTYPE HTML>
<html>
<head>
    <!-- twitter bootstrap CSS stylesheet - not required by cornerstone -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- cornerstone css - provides some useful css classes -->
    <link href="../../dist/cornerstone.css" rel="stylesheet">

</head>
<body>
<div class="container">

    <h1>
        colormap/index.html
    </h1>

    <div class="row">
        <div class="col-xs-10">
            <div style="width:512px; padding-top: 5px;">
                <canvas id="colormapBar" width="512px" height="20px"></canvas>
            </div>
            <!-- note we disable selection on the top most div -->
            <div style="width:512px;height:512px;position:relative;color: white;"
                 class="cornerstone-enabled-image"
                 oncontextmenu="return false"
                 unselectable='on'
                 onselectstart='return false;'
                 onmousedown='return false;'>
                <div id="dicomImage"
                     style="width:512px;height:512px;top:0px;left:0px; position:absolute">
                </div>
            </div>
        </div>
        <div class="col-xs-2">
            <label for="opacityImage1"> Opacity Image 1 </label>
            <input id="opacityImage1" type="range" class="range" min=0 max=1 step=0.1 value=1>

            <label for="opacityImage2"> Opacity Image 2 </label>
            <input id="opacityImage2" type="range" class="range" min=0 max=1 step=0.1 value=0.5>

            <label for="opacityImage2"> Colormap </label>
            <select id="colormaps" style="width:100%"></select>
        </div>
    </div>
</div>
</body>

<!-- cornerstone depends on jQuery so it must be loaded first-->
<script src="../jquery.min.js"></script>

<!-- include the cornerstone library -->
<script src="../../dist/cornerstone.js"></script>

<script src="../dicomParser.js"></script>
<script src="../cornerstoneMath.js"></script>
<script src="../cornerstoneTools.js"></script>
<script src="../cornerstoneWADOImageLoader.js"></script>

<!-- include special code for these examples which provides images -->
<script src="../exampleImageIdLoader.js"></script>

<script>

    function fillColormapsList() {
        var $dropdown = $('#colormaps');
        var colormapsList = cornerstone.colors.getColormapsList();

        colormapsList.forEach(function(colormapItem) {
            var $option = $('<option></option>')
                .val(colormapItem.id)
                .text(colormapItem.name)

            $dropdown.append($option);
        });

        $dropdown.val('hot');
    }

    $(document).ready(function() {
        // image enable the dicomImage element
        var element = $('#dicomImage').get(0);
        cornerstone.enable(element);

        var host = window.location.href.replace('/index.html','');
        
        var imageId = 'example://1';
        var imageId2 = 'example://2';
        var layer1id, layer2id;
        var falseColorImage;

        cornerstone.loadImage(imageId).then(function(image) {
            layer1id = cornerstone.addLayer(element, image, {
                opacity: 1
            });

            console.log('IMAGE ONE:');
            console.log(image);

            cornerstone.updateImage(element);

            cornerstoneTools.mouseInput.enable(element);
            cornerstoneTools.mouseWheelInput.enable(element);
            // Enable all tools we want to use with this element
            cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
            cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
            cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
            cornerstoneTools.stackScrollWheel.activate(element);

        }, function(error) {
            console.log(error);
        });

        cornerstone.loadImage(imageId2).then(function(image) {
            console.log('IMAGE TWO:');
            console.log(image);

            falseColorImage = image;

            var colormap = cornerstone.colors.getColormap('hot');
            var lookupTable = colormap.createLookupTable();
            cornerstone.pixelDataToFalseColorData(image, lookupTable);

            layer2id = cornerstone.addLayer(element, image, {
                opacity: 0.5
            });

            cornerstone.updateImage(element);
        }, function(error) {
            console.log(error);
        });

        function colormapChanged() {
            var colormapId = $('#colormaps').val();
            var colormap = cornerstone.colors.getColormap(colormapId);
            var lookupTable = colormap.createLookupTable();

            cornerstone.pixelDataToFalseColorData(falseColorImage, lookupTable);
            cornerstone.updateImage(element, true);

            updateColormapBar(lookupTable)
        }

        function updateColormapBar(lookupTable) {
            var canvas = $('#colormapBar').get(0);
            var ctx = canvas.getContext('2d');
            var height = canvas.height;
            var width = canvas.width;
            var colorbar = ctx.createImageData(512, 20);

            lookupTable.setTableRange(0, width);

            for(var x = 0; x < width; x++) {
                var color = lookupTable.mapValue(x);

                for(var y = 0; y < height; y++) {
                    var pixel = (x + y * width) * 4;
                    colorbar.data[pixel] = color[0];
                    colorbar.data[pixel+1] = color[1];
                    colorbar.data[pixel+2] = color[2];
                    colorbar.data[pixel+3] = color[3];
                }
            }

            ctx.putImageData(colorbar, 0, 0);
        }

        $("#opacityImage1").change(function(event) {
            var layer = cornerstone.getLayers(element, layer1id);
            layer.options.opacity = parseFloat(event.currentTarget.value);
            cornerstone.updateImage(element);
        });

        $("#opacityImage2").change(function(event) {
            var layer = cornerstone.getLayers(element, layer2id);
            layer.options.opacity = parseFloat(event.currentTarget.value);
            cornerstone.updateImage(element);
        });

        $('#colormaps').change(function() {
            colormapChanged();
        });

        fillColormapsList();

        setTimeout(function() {
            $('#colormaps').trigger('change');
        }, 1);
    });

</script>
</html>
