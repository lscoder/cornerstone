<!DOCTYPE HTML>
<html>
<head>
    <!-- twitter bootstrap CSS stylesheet - not required by cornerstone -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- cornerstone css - provides some useful css classes -->
    <link href="../../dist/cornerstone.css" rel="stylesheet">

</head>
<body>
<div class="container">

    <h1>
        layers/index.html
    </h1>

    Layers Example

    
    <div class="row">
        <div class="col-xs-10">
            <!-- note we disable selection on the top most div -->
            <div style="width:512px;height:512px;position:relative;color: white;"
                 class="cornerstone-enabled-image"
                 oncontextmenu="return false"
                 unselectable='on'
                 onselectstart='return false;'
                 onmousedown='return false;'>
                <div id="dicomImage"
                     style="width:512px;height:512px;top:0px;left:0px; position:absolute">
                </div>
            </div>
        </div>
        <div class="col-xs-2">
            <div style="margin-bottom: 15px;">
                <label for="syncvViewports"> Syncv Viewports</label><br>
                <input name="syncvViewports" type="radio" value="1" checked> Yes &nbsp;&nbsp;
                <input name="syncvViewports" type="radio" value="0"> No
            </div>
        </div>
        <div class="col-xs-2">
            <label for="layers">Layers</label>
            <select name="layers" id="layers" size="2" autofocus style="width: 100%; min-width: 150px;"></select>
            <div id="properties" style="width: 100%; min-width: 150px; margin-top: 15px;">
                <label>Properties</label>
                <div style="width: 100%; padding: 5px 5px 5px 10px;">
                    <div style="margin-bottom: 15px;">
                        <label for="visible"> Visible</label><br>
                        <input name="visible" type="radio" value="1"> Yes &nbsp;&nbsp;
                        <input name="visible" type="radio" value="0"> No
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="imageOpacity"> Opacity</label>
                        <input id="imageOpacity" type="range" class="range" min=0 max=1 step=0.1 value=0>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<!-- cornerstone depends on jQuery so it must be loaded first-->
<script src="../jquery.min.js"></script>

<!-- include the cornerstone library -->
<script src="../../dist/cornerstone.js"></script>

<script src="../dicomParser.js"></script>
<script src="../cornerstoneMath.js"></script>
<script src="../cornerstoneTools.js"></script>
<script src="../cornerstoneWADOImageLoader.js"></script>

<!-- include special code for these examples which provides images -->
<script src="../exampleImageIdLoaderCt.js"></script>
<script src="../exampleImageIdLoader.js"></script>
<script src="../exampleMetaDataProvider.js"></script>

<script>

    $(document).ready(function() {
        // image enable the dicomImage element
        var element = $('#dicomImage').get(0);
        cornerstone.enable(element);

        var host = window.location.href.replace('/index.html','');

        // Load and display the image
        // 
        // The `name` option is used only by this example.
        // Cornerstone doesn't know that it exists.
        //
        var layers = [
            // {
            //     imageId: 'dicomweb:' + host + '/object-78.dcm',
            //     options: {
            //         name: 'object-78.dcm'
            //     }
            // },
            // {
            //     imageId: 'dicomweb:' + host + '/object.SEG.dcm?frame=78',
            //     options: {
            //         name: 'object.SEG.dcm',
            //         opacity: 0.5
            //     }
            // }
            // {
            //     imageId: 'dicomweb:' + host + '/ct.dcm',
            //     options: {
            //         name: 'CT',
            //     }
            // },
            // {
            //     imageId: 'dicomweb:' + host + '/pet.dcm',
            //     options: {
            //         name: 'PET',
            //     }
            // },
            {
                imageId: 'example://1',
                options: {
                    name: 'Example 1'
                }
            },
            // {
            //     imageId: 'example://2',
            //     options: {
            //         name: 'Example 2'
            //     }
            // },
            // {
            //     imageId: 'ctexample://1',
            //     options: {
            //         name: 'CT Example'
            //     }
            // },
            {
                imageId: 'dicomweb:' + host + '/color.dcm',
                options: {
                    name: 'Color image'
                }
            }
        ];

        var orientationMarkersConfig = {
            drawAllMarkers: true
        }

        var textMarkerConfig = {
            'markers' : ['L5', 'L4', 'L3', 'L2', 'L1', // Lumbar spine
                         'T12', 'T11', 'T10', 'T9', 'T8', 'T7', // Thoracic spine
                         'T6', 'T5', 'T4', 'T3', 'T2', 'T1',
                         'C7', 'C6', 'C5', 'C4', 'C3', 'C2', 'C1', // Cervical spine
                         ],
            'current': 'C7',
            'ascending': true,
            'loop': true,
            'changeTextCallback': function(data, eventData, callback) {
                callback(data, data.text + '.');
            }
        }

        function loadLayers() {
            loadImages().then(function() {
                var images = Array.prototype.slice.call(arguments);
                
                images.forEach(function(image, index) {
                    var layer = layers[index];
                    var layerId = cornerstone.addLayer(element, image, layer.options);

                    cornerstone.updateImage(element);
                    console.log('Layer ' + index + ': ' + layerId);
                });

                // Update dropdown size to make all layers name visible
                $('#layers').prop('size', layers.length);

                // Enable cornerstone tools
                enableTools();
            });
        }

        function loadImages() {
            var promises = [];

            layers.forEach(function(layer) {
                var loadPromise = cornerstone.loadImage(layer.imageId);
                promises.push(loadPromise);
            });

            return $.when.apply($, promises);
        }

        function enableTools() {
            cornerstoneTools.mouseInput.enable(element);
            cornerstoneTools.mouseWheelInput.enable(element);
            cornerstoneTools.magnify.enable(element);
            cornerstoneTools.orientationMarkers.enable(element);
            // cornerstoneTools.arrowAnnotate.setConfiguration(arrowAnnotateConfig);
            // cornerstoneTools.seedAnnotate.setConfiguration(seedAnnotateConfig);
            cornerstoneTools.orientationMarkers.setConfiguration(orientationMarkersConfig);

            // Enable all tools we want to use with this element
            // cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
            // cornerstoneTools.probe.activate(element, 1);
            // cornerstoneTools.dragProbe.activate(element, 1);
            // cornerstoneTools.simpleAngle.activate(element, 1);
            // cornerstoneTools.arrowAnnotate.activate(element, 1);
            // cornerstoneTools.length.activate(element, 1);
            // cornerstoneTools.freehand.activate(element, 1);
            // cornerstoneTools.highlight.activate(element, 1);
            // cornerstoneTools.magnify.activate(element, 1);

            // cornerstoneTools.orientationMarkers.enable(element);
            // cornerstoneTools.seedAnnotate.activate(element, 1);
            // cornerstoneTools.textMarker.enable(element);
            // cornerstoneTools.textMarker.setConfiguration(textMarkerConfig);
            // cornerstoneTools.textMarker.activate(element, 1);
            // cornerstoneTools.wwwcRegion.activate(element, 1);

            cornerstoneTools.rotate.activate(element, 1);
            cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
            cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
            cornerstoneTools.zoomWheel.activate(element); // zoom is the default tool for middle mouse wheel
        }

        $("#layers").change(function(event) {
            var layerId = event.currentTarget.value;
            cornerstone.setActiveLayer(element, layerId);
        });

        $("#imageOpacity").change(function(event) {
            var layer = cornerstone.getActiveLayer(element);
            layer.options.opacity = parseFloat(event.currentTarget.value);
            cornerstone.updateImage(element);
        });

        $('input[name=visible]').change(function(event) {
            var layer = cornerstone.getActiveLayer(element);
            layer.options.visible = (event.currentTarget.value === "1");
            cornerstone.updateImage(element);
        });

        $('input[name=syncvViewports]').change(function(event) {
            var enabledElement = cornerstone.getEnabledElement(element);
            enabledElement.syncViewports = (event.currentTarget.value === "1");
            cornerstone.updateImage(element);
        });

        $(element).on('CornerstoneLayerAdded', function(e, eventData) {
            var layer = cornerstone.getLayers(eventData.element, eventData.layerId);
            var $layers = $('#layers');
            var $layerOption = $('<option></option>')
                .val(layer.layerId)
                .text(layer.options.name);

            $('#layers').append($layerOption);
        });

        $(element).on('CornerstoneActiveLayerChanged', function(e, eventData) {
            var layer = cornerstone.getActiveLayer(element);
            var opacity = layer.options.opacity == null ? 1 : layer.options.opacity;
            var visible = layer.options.visible !== false ? 1 : 0;

            $('#imageOpacity').val(opacity);
            $("input[name=visible][value=" + visible + "]").prop('checked', true);

            updateSelectedLayer(eventData.layerId);
        });

        function updateSelectedLayer(layerId) {
            var $layers = $('#layers');

            setTimeout(function() {
                var currentLayerId = $layers.val();

                if(currentLayerId !== layerId) {
                    $layers.val(layerId);
                    $layers.trigger('change');
                }
            }, 0);
        }

        loadLayers();
    });

</script>
</html>
